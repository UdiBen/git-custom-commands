#!/bin/sh

# Use BASE_BRANCH environment variable, default to main
BASE_BRANCH=${BASE_BRANCH:-main}

BRANCH_NAME=$1

# Fetch the latest changes from the remote repository
git fetch --all

# Check for uncommitted changes and stash them if they exist
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Stashing uncommitted changes..."
  git stash
  STASHED=true
else
  STASHED=false
fi

# Checkout the base branch
git checkout $BASE_BRANCH

# Pull the latest changes on the base branch
git pull origin $BASE_BRANCH

# Create and checkout the new branch
git checkout -b $BRANCH_NAME

# Pop the stash if it was stashed
if [ "$STASHED" = true ]; then
  echo "Applying stashed changes..."
  git stash pop
fi

echo "Branch '$BRANCH_NAME' created from '$BASE_BRANCH' and checked out."